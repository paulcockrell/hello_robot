<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Rusty Robot Dashboard</title>
    <link rel="stylesheet" href="/static/pico.min.css" />
    <link rel="stylesheet" href="/static/orbit.min.css" />
    <link rel="stylesheet" href="/static/robot.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <main class="container">
      <section>
        <h3>Camera</h3>
        <img id="camera" src="/camera/frame.mjpeg" />
      </section>
      <section>
        <h3>Sensors</h3>
        <div id="ultrasound_sensor">Loading ultrasound data…</div>
        <div id="ldr_sensor">Loading ldr data…</div>
      </section>

      <section>
        <div id="app"></div>
      </section>
    </main>

    <script src="/static/orbit.min.js"></script>
    <script>
      const ws = new WebSocket("ws://raspberrypi.local:3000/ws");

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.Ultrasound) {
          console.log("Ultrasound:", msg.Ultrasound);
          document.getElementById("ultrasound_sensor").innerText =
            msg.Ultrasound.distance.toFixed(1);
        }

        if (msg.Ldr) {
          console.log("LDR:", msg.Ldr);
          document.getElementById("ldr_sensor").innerText =
            `left=${msg.Ldr.l_val}, middle=${msg.Ldr.m_val}, right=${msg.Ldr.r_val}`;
        }
      };
    </script>

    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.23.1",
          "preact/": "https://esm.sh/preact@10.23.1/",
          "@preact/signals": "https://esm.sh/@preact/signals@1.3.0?external=preact",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
        }
      }
    </script>

    <script type="module">
      import { Fragment, render } from "preact";
      import { signal } from "@preact/signals";
      import { html } from "htm/preact";

      const API_BASE_URL = "http://raspberrypi.local:3000/api";
      const SUB_MENUS = {
        servo: {
          path: "servo",
          orbitButtonClass: "orbit-5 shrink-70 from-120 range-120",
          orbitAccentClass: "orbit-6 grow-1x from-120 range-120",
          buttons: [
            ["servo.end", "bi-skip-end-circle-fill", 120, 15],
            ["servo.increment", "bi-plus-circle-fill", 150, 15],
            ["servo.decrement", "bi-dash-circle-fill", 180, 15],
            ["servo.start", "bi-skip-start-circle-fill", 210, 15],
          ],
        },

        leds: {
          path: "leds",
          orbitButtonClass: "orbit-5 shrink-70 range-120",
          orbitAccentClass: "orbit-6 grow-1x range-120",
          buttons: [
            ["leds.increment", "bi-plus-circle-fill", 0, 30],
            ["leds.decrement", "bi-dash-circle-fill", 60, 30],
          ],
        },

        motor: {
          path: "motor",
          orbitButtonClass: "orbit-5 shrink-70 from-240 range-120",
          orbitAccentClass: "orbit-6 grow-1x from-240 range-120",
          buttons: [
            ["motor.forward", "bi-arrow-up-circle-fill", 330, 15],
            ["motor.right", "bi-arrow-right-circle-fill", 300, 15],
            ["motor.left", "bi-arrow-left-circle-fill", 270, 15],
            ["motor.backward", "bi-arrow-down-circle-fill", 240, 15],
          ],
        },
      };

      const mainMenuActive = signal(null);
      const subMenuActive = signal(null);

      const cx = (obj) =>
        Object.entries(obj)
          .filter(([, v]) => v)
          .map(([k]) => k)
          .join(" ");

      function App() {
        // If the main menu option changes, reset the submenu option
        mainMenuActive.subscribe(() => (subMenuActive.value = null));

        const handleClick = async (url, actionName, opts = {}) => {
          subMenuActive.value = actionName;

          const method = "post";
          const body = JSON.stringify({ action: actionName, ...opts });
          const headers = new Headers();
          headers.append("Content-Type", "application/json");

          try {
            const response = await fetch(url, {
              method,
              headers,
              body,
            });

            if (!response.ok) {
              console.error("Error processing request", response.status);
              return;
            }

            const result = await response.json();
            console.log(result);
          } catch (error) {
            console.error("Error making request", error);
          }
        };

        return html`
          <div class="bigbang x-dev-orbit">
            <div class="gravity-spot menu-example" style="--o-force: 600px">
              <${MenuTitle} />
              <${MainMenu} />
              <${SubMenu} onClick=${handleClick} />
              <${Sensors} />
            </div>
          </div>
        `;
      }

      function MenuTitle() {
        return html`
          <div class="orbit-0">
            <div class="capsule at-center">MENU</div>
          </div>
        `;
      }

      function MainMenuButton({ name }) {
        const handleClick = () => (mainMenuActive.value = name.toLowerCase());

        return html`<o-arc
          class="grow-1x control-size"
          onClick=${handleClick}
        ></o-arc>`;
      }

      function MainMenuButtons() {
        return html`
          <div class="orbit-3 main-menu">
            ${["leds", "servo", "motor"].map(
              (name) =>
                html`<${MainMenuButton}
                  name=${name}
                  key=${`main-menu-button-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function MainMenuLabel({ name }) {
        const handleClick = () => (mainMenuActive.value = name.toLowerCase());

        return html`
          <o-arc class="flip" onClick=${handleClick}> ${name} </o-arc>
        `;
      }

      function MainMenuLabels({ action }) {
        return html`
          <div class="orbit-3 main-menu">
            ${["LEDs", "Servo", "Motor"].map(
              (name) =>
                html`<${MainMenuLabel}
                  action=${action}
                  name=${name}
                  key=${`main-menu-label-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function MainMenuAccent({ name }) {
        return html`<o-arc
          class=${cx({
            "accent shrink-65 inner-orbit": true,
            active: mainMenuActive.value === name,
          })}
        ></o-arc>`;
      }

      function MainMenuAccents({ active }) {
        return html`
          <div class="orbit-4">
            ${["leds", "servo", "motor"].map(
              (name) =>
                html`<${MainMenuAccent}
                  active=${active}
                  name=${name}
                  key=${`main-menu-accent-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function MainMenu({ active }) {
        return html`
          <${MainMenuButtons} />
          <${MainMenuAccents} />
          <${MainMenuLabels} />
        `;
      }

      function SubMenu({ onClick }) {
        if (!mainMenuActive.value) return html`<${Fragment} />`;

        return html`
          <${SubMenuBuilder}
            name=${mainMenuActive.value}
            config=${SUB_MENUS[mainMenuActive.value]}
            onClick=${onClick}
            active=${subMenuActive.value}
          />
        `;
      }

      function SubMenuBuilder({ name, config, onClick, active }) {
        const url = `${API_BASE_URL}/${config.path}`;

        return html`
          <div class=${`${config.orbitButtonClass}`}>
            ${config.buttons.map(
              ([name, icon, angle, offset]) =>
                html` <${OrbitActionButton}
                  name=${name}
                  icon=${icon}
                  angle=${angle}
                  labelAngle=${angle + offset}
                  onClick=${onClick}
                  url=${url}
                  key=${`orbit-action-button-${name}`}
                />`,
            )}
          </div>

          <div class=${`${config.orbitAccentClass}`}>
            ${config.buttons.map(
              ([name, icon, angle]) =>
                html` <${OrbitActionAccent}
                  active=${active}
                  name=${name}
                  angle=${angle}
                  key=${`orbit-action-accent-${name}`}
                />`,
            )}
          </div>
        `;
      }

      function OrbitActionButton({
        name,
        icon,
        angle,
        labelAngle,
        active,
        url,
        onClick,
      }) {
        const handleMouseDown = () => onClick(url, name);
        const handleMouseUp = () => onClick(url, "motor.stop");

        return html`
          <!-- Button -->
          <o-arc
            class=${cx({
              "outer-orbit": true,
              "grow-1x": true,
              [`angle-${angle}`]: true,
            })}
            onMouseDown=${handleMouseDown}
            onMouseUp=${handleMouseUp}
          ></o-arc>

          <!-- Button Label (Icon) -->
          <div
            class=${cx({
              satellite: true,
              "outer-orbit": true,
              "grow-1x": true,
              [`angle-${labelAngle}`]: true,
            })}
            onMouseDown=${handleMouseDown}
            onMouseUp=${handleMouseUp}
          >
            <div class="capsule">
              <i class=${`bi ${icon}`}></i>
            </div>
          </div>
        `;
      }

      function OrbitActionAccent({ angle, active, name }) {
        return html`
          <o-arc
            class=${cx({
              "shrink-80": true,
              [`angle-${angle}`]: true,
              accent: true,
              active: active === name,
            })}
          ></o-arc>
        `;
      }

      function Sensors() {
        return html`
          <div class="orbit-8 sensors">
            <div class="satellite">
              <div class="gravity-spot">
                <div class="orbit">
                  <div class="satellite grow-1x at-center">60cm</div>
                </div>
                <div class="orbit-2 range-180 from-180">
                  <o-arc shape="circle" class="shrink-50"></o-arc>
                </div>
                <div class="orbit-3 range-270 ">
                  <o-arc shape="circle" class="shrink-50"></o-arc>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      render(html`<${App} />`, document.getElementById("app"));
    </script>
  </body>
</html>
